<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Book Ticket</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    label { display:block; margin-top:10px; }
    input, select { width: 100%; padding:8px; margin-top:4px; box-sizing:border-box; }
    button { margin-top:12px; padding:10px 16px; background:#e74c3c; color:#fff; border:none; cursor:pointer }
    .ticket { border:1px solid #ddd; padding:12px; margin-top:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Book Ticket / Ticket Details</h1>

    <div id="ticketSection">
      <div id="bookForm">
        <h3>New Booking</h3>

        <label for="locationId">Location</label>
        <select id="locationId"><option>Loading...</option></select>

        <label for="startDate">Start Date</label>
        <input id="startDate" type="date">

        <label for="endDate">End Date</label>
        <input id="endDate" type="date">

        <label for="totalPrice">Total Price</label>
        <input id="totalPrice" type="number" step="0.01">

        <button id="bookBtn">Book Ticket</button>
      </div>

      <div id="ticketDetail" style="display:none;">
        <h3>Ticket Details</h3>
        <div id="ticketInfo" class="ticket"></div>
      </div>
    </div>

    <p><a href="/user.html">Back to Profile</a></p>
  </div>

<script>
const token = localStorage.getItem('token');

async function loadLocations() {
  try {
    const res = await fetch('/api/locations');
    if (!res.ok) throw new Error('Failed to load locations');
    const locations = await res.json();
    const sel = document.getElementById('locationId');
    sel.innerHTML = locations.map(l => `<option value="${l._id}">${l.name} — ₹${l.price || 'N/A'}</option>`).join('');
    const preLoc = new URLSearchParams(location.search).get('loc');
    if (preLoc) sel.value = preLoc;
  } catch (err) {
    console.error('Failed to load locations', err);
    const sel = document.getElementById('locationId');
    sel.innerHTML = '<option value="">Unable to load locations</option>';
  }
}

async function createBooking() {
  if (!token) { alert('Please log in first'); window.location.href = '/login.html'; return; }

  const location = document.getElementById('locationId').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const totalPrice = parseFloat(document.getElementById('totalPrice').value);

  if (!location || !startDate || !endDate || !totalPrice) { alert('All fields required'); return; }

  try {
    const res = await fetch('/api/bookings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ location, startDate, endDate, totalPrice })
    });
    const data = await res.json();
    if (!res.ok) { alert(data.message || 'Booking failed'); console.error('booking failed', data); return; }
    showTicket(data._id);
  } catch (err) {
    console.error(err); alert('Booking error');
  }
}

async function showTicket(id) {
  const bookingId = id || new URLSearchParams(location.search).get('id');
  if (!bookingId) return;
  try {
    const res = await fetch('/api/bookings/' + bookingId, { headers: { Authorization: 'Bearer ' + token } });
    const b = await res.json();
    if (!res.ok) { alert(b.message || 'Cannot load ticket'); return; }
    document.getElementById('bookForm').style.display = 'none';
    document.getElementById('ticketDetail').style.display = 'block';
    document.getElementById('ticketInfo').innerHTML = `
      <p><strong>${b.location?.name || 'Location'}</strong></p>
      <p>Dates: ${new Date(b.startDate).toLocaleDateString()} - ${new Date(b.endDate).toLocaleDateString()}</p>
      <p>Price: ${b.totalPrice}</p>
      <p>Status: ${b.status}</p>
    `;
  } catch (err) {
    console.error(err);
    alert('Error loading ticket');
  }
}

document.getElementById('bookBtn').addEventListener('click', createBooking);
window.addEventListener('load', () => {
  loadLocations();
  const id = new URLSearchParams(location.search).get('id');
  if (id) showTicket(id);
});
</script>
</body>
</html>